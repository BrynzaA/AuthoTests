pipeline {
    agent any

    options {
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
    }

    stages {
        stage('Cleanup Previous Containers') {
            steps {
                script {
                    bat '''
                        echo Cleaning up previous Docker containers...
                        docker-compose down -v --remove-orphans 2>nul || echo No containers to stop
                        docker system prune -f 2>nul
                    '''
                }
            }
        }

        stage('Prepare Environment') {
            steps {
                script {
                    bat '''
                        mkdir test-output 2>nul
                        mkdir target 2>nul
                        rmdir /s /q selenoid\\videos 2>nul
                        mkdir selenoid\\videos 2>nul
                        mkdir selenoid\\logs 2>nul

                        rem Очищаем target директорию
                        rmdir /s /q target 2>nul
                        mkdir target 2>nul
                        rmdir /s /q test-output 2>nul
                        mkdir test-output 2>nul
                    '''
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    bat 'docker build -t autotests-runner:latest .'
                }
            }
        }

        stage('Prepare Browser Images') {
            steps {
                script {
                    bat '''
                        echo Загружаем необходимые Docker-образы для Selenoid...

                        rem Загружаем образ Chrome (главный, который у тебя в browsers.json)
                        docker pull selenoid/chrome:latest

                        rem Для надежности можно подождать
                        echo Проверяем, что образ загрузился...
                        docker images selenoid/chrome
                    '''
                }
            }
        }

        stage('Start Selenoid') {
            steps {
                script {
                    bat '''
                        echo Starting Selenoid...

                        docker run -d --name selenoid -p 4444:4444 -v /var/run/docker.sock:/var/run/docker.sock -v "%cd%\\selenoid\\videos:/opt/selenoid/video" -v "%cd%\\selenoid\\logs:/opt/selenoid/logs" -v "%cd%\\browsers.json:/etc/selenoid/browsers.json:ro" aerokube/selenoid:latest-release

                        echo Waiting for Selenoid to start...
                        ping -n 10 127.0.0.1 >nul

                        curl -f http://localhost:4444/status
                        if errorlevel 1 (
                            echo ERROR: Selenoid failed to start
                            exit /b 1
                        ) else (
                            echo SUCCESS: Selenoid is running!
                        )
                    '''
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    bat '''
                        echo Running tests with Selenoid...

                        rem Запускаем тесты с явным указанием использовать Selenoid
                        docker run --rm --name tests --network host -v "%cd%\\test-output:/app/test-output" autotests-runner:latest sh -c "mvn clean test -Dselenium.host=localhost -Dselenium.port=4444 -Dbrowser=chrome -Dselenium.remote=true"

                        if errorlevel 1 (
                            echo WARNING: Tests may have failed, but collecting results...
                        )
                    '''
                }
            }
        }

        stage('Generate Reports') {
            steps {
                script {
                    bat '''
                        echo Generating reports...

                        rem Генерируем Allure отчет
                        docker run --rm --name report-generator -v "%cd%\\test-output:/app/test-output" autotests-runner:latest sh -c "if [ -d /app/test-output/allure-results ]; then mvn allure:report -Dallure.results.directory=/app/test-output/allure-results; fi"

                        rem Копируем результаты из контейнера тестов
                        docker cp tests:/app/target/surefire-reports target/ 2>nul || echo No surefire reports to copy
                        docker cp tests:/app/target/allure-results target/ 2>nul || echo No allure results to copy

                        rem Также копируем из test-output
                        if exist "test-output" (
                            echo Copying from test-output...
                            xcopy /E /I /Y test-output\\* target\\ 2>nul
                        )
                    '''
                }
            }
        }

        stage('Collect Results') {
            steps {
                script {
                    bat '''
                        echo Collecting test results...

                        docker logs tests > test-runner.log 2>&1
                        docker logs selenoid > selenoid.log 2>&1

                        rem Создаем структуру если пусто
                        mkdir target\\surefire-reports 2>nul
                        mkdir target\\allure-results 2>nul
                        mkdir target\\allure-report 2>nul

                        rem Проверяем что есть
                        echo --- Contents of target directory ---
                        dir target 2>nul || echo target directory is empty
                        echo --- Contents of test-output directory ---
                        dir test-output 2>nul || echo test-output directory is empty
                    '''

                    archiveArtifacts artifacts: 'test-runner.log, selenoid.log'

                    // Проверяем наличие файлов перед архивированием
                    script {
                        def hasTargetFiles = bat(script: 'if exist "target\\*" (exit 0) else (exit 1)', returnStatus: true) == 0
                        if (hasTargetFiles) {
                            archiveArtifacts artifacts: 'target/**/*'
                        } else {
                            echo 'No files found in target directory to archive'
                        }
                    }
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                script {
                    // Проверяем наличие результатов Allure
                    bat '''
                        if exist "target\\allure-results" (
                            echo Found allure-results, generating report...
                            dir target\\allure-results
                        ) else (
                            echo No allure-results found
                        )
                    '''

                    // Используем Jenkins Allure plugin
                    allure([
                        results: [[path: 'target/allure-results']],
                        report: 'target/allure-report'
                    ])
                }
            }
        }

        stage('Stop Containers') {
            steps {
                script {
                    bat '''
                        echo Stopping Docker containers...
                        docker stop tests 2>nul
                        docker stop selenoid 2>nul
                        docker stop report-generator 2>nul
                        docker rm selenoid 2>nul
                    '''
                }
            }
        }
    }

    post {
        always {
            // Проверяем наличие XML отчетов для JUnit
            bat '''
                echo Checking for JUnit reports...
                if exist "target\\surefire-reports\\*.xml" (
                    echo Found JUnit XML reports
                ) else (
                    echo No JUnit XML reports found
                    rem Создаем минимальный XML чтобы Jenkins не ругался
                    mkdir target\\surefire-reports 2>nul
                    echo ^<?xml version="1.0" encoding="UTF-8"?^> > target\\surefire-reports\\TEST-empty.xml
                    echo ^<testsuite name="empty" tests="0" failures="0" errors="0" skipped="0" time="0"^> >> target\\surefire-reports\\TEST-empty.xml
                    echo ^</testsuite^> >> target\\surefire-reports\\TEST-empty.xml
                )
            '''

            junit testResults: 'target/surefire-reports/*.xml', allowEmptyResults: true

            emailext(
                to: 'aleksandr.brynza@simbirsoft.com',
                subject: "${currentBuild.currentResult}: Docker Tests - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                    <h2>${currentBuild.currentResult}: Тесты в Docker контейнерах</h2>
                    <p><b>Проект:</b> ${env.JOB_NAME}</p>
                    <p><b>Сборка:</b> #${env.BUILD_NUMBER}</p>
                    <p><b>Статус:</b> ${currentBuild.currentResult}</p>
                    <p><b>Длительность:</b> ${currentBuild.durationString}</p>

                    <h3>Артефакты:</h3>
                    <ul>
                        <li><a href="${env.BUILD_URL}">Подробности сборки</a></li>
                        <li><a href="${env.BUILD_URL}allure/">Allure отчет</a></li>
                        <li><a href="${env.BUILD_URL}testReport/">JUnit отчет</a></li>
                    </ul>

                    <h3>Логи:</h3>
                    <ul>
                        <li><a href="${env.BUILD_URL}artifact/test-runner.log">Лог тестов</a></li>
                        <li><a href="${env.BUILD_URL}artifact/selenoid.log">Лог Selenoid</a></li>
                    </ul>

                    <p><small>Запуск в Docker контейнерах с Selenoid</small></p>
                """,
                mimeType: 'text/html'
            )

            cleanWs()
        }
    }
}