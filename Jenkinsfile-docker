pipeline {
    agent any

    environment {
        COMPOSE_PROJECT_NAME = "autotests-${env.BUILD_NUMBER}"
    }

    options {
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()  // Важно: запретить параллельные сборки
    }

    stages {
        stage('Cleanup Previous Containers') {
            steps {
                script {
                    bat '''
                        echo Cleaning up previous Docker containers...

                        rem Останавливаем контейнеры с именем selenoid
                        docker stop selenoid 2>nul || echo No selenoid container to stop
                        docker rm selenoid 2>nul || echo No selenoid container to remove

                        rem Останавливаем контейнеры с именем selenoid-ui
                        docker stop selenoid-ui 2>nul || echo No selenoid-ui container to stop
                        docker rm selenoid-ui 2>nul || echo No selenoid-ui container to remove

                        rem Останавливаем контейнеры тестов
                        docker stop tests 2>nul || echo No tests container to stop
                        docker rm tests 2>nul || echo No tests container to remove

                        rem Останавливаем все контейнеры проекта
                        docker-compose down -v --remove-orphans 2>nul || echo No containers to stop

                        rem Очищаем сети
                        docker network prune -f
                    '''
                }
            }
        }

        stage('Prepare Environment') {
            steps {
                script {
                    bat 'docker --version'
                    bat 'docker-compose --version'

                    bat '''
                        mkdir allure-results 2>nul
                        mkdir allure-report 2>nul
                        mkdir test-results 2>nul
                        mkdir target 2>nul
                        mkdir selenoid\\video 2>nul
                        mkdir selenoid\\logs 2>nul
                    '''
                }
            }
        }

        stage('Build Docker Images') {
            steps {
                script {
                    bat 'docker build -t autotests-runner:latest .'

                    bat 'docker build -t selenoid-custom:latest ./selenoid'
                }
            }
        }

        stage('Start Containers') {
            steps {
                script {
                    bat '''
                        rem Указываем уникальное имя проекта для этой сборки
                        set COMPOSE_PROJECT_NAME=autotests-%BUILD_NUMBER%

                        echo Starting Selenoid with project name: %COMPOSE_PROJECT_NAME%
                        docker-compose -p %COMPOSE_PROJECT_NAME% up -d selenoid

                        rem Ждем запуска Selenoid
                        echo Waiting for Selenoid to start...
                        ping -n 10 127.0.0.1 >nul

                        rem Проверяем что Selenoid запустился
                        echo Checking Selenoid status...
                        curl -f http://localhost:4444/status && echo Selenoid is running! || echo Selenoid failed to start

                        rem Проверяем через powershell если curl не работает
                        powershell -Command "try { $response = Invoke-WebRequest -Uri 'http://localhost:4444/status' -TimeoutSec 5; Write-Host 'Selenoid status:' $response.Content } catch { Write-Host 'Selenoid not responding' }"
                    '''
                }
            }
        }

        stage('Run Tests in Docker') {
            steps {
                script {
                    bat '''
                        set COMPOSE_PROJECT_NAME=autotests-%BUILD_NUMBER%
                        echo Running tests with project name: %COMPOSE_PROJECT_NAME%
                        docker-compose -p %COMPOSE_PROJECT_NAME% run --rm tests
                    '''
                }
            }

            post {
                always {
                    script {
                        bat '''
                            set COMPOSE_PROJECT_NAME=autotests-%BUILD_NUMBER%
                            docker-compose -p %COMPOSE_PROJECT_NAME% logs tests > test-runner.log
                            docker-compose -p %COMPOSE_PROJECT_NAME% logs selenoid > selenoid.log
                        '''

                        archiveArtifacts artifacts: 'test-runner.log, selenoid.log'
                    }
                }
            }
        }

        stage('Collect Results') {
            steps {
                script {
                    bat '''
                        echo Collecting test results...

                        rem Копируем результаты тестов
                        if exist "test-results" (
                            echo Copying test results...
                            xcopy /E /I /Y test-results\\* target\\ 2>nul
                        )

                        rem Копируем Allure результаты
                        if exist "allure-results" (
                            echo Copying allure results...
                            mkdir target\\allure-results 2>nul
                            xcopy /E /I /Y allure-results\\* target\\allure-results\\ 2>nul
                        )

                        rem Копируем Allure отчет
                        if exist "allure-report" (
                            echo Copying allure report...
                            mkdir target\\site\\allure-maven-plugin 2>nul
                            xcopy /E /I /Y allure-report\\* target\\site\\allure-maven-plugin\\ 2>nul
                        )

                        rem Создаем JUnit отчеты если их нет
                        if not exist "target\\surefire-reports" (
                            echo Creating dummy test report...
                            mkdir target\\surefire-reports 2>nul
                            echo "<?xml version='1.0' encoding='UTF-8'?>" > target\\surefire-reports\\dummy.xml
                            echo "<testsuite name='DummyTest' tests='1' failures='0' errors='0'>" >> target\\surefire-reports\\dummy.xml
                            echo "<testcase name='dummyTest' classname='DummyTest' time='0.001'/>" >> target\\surefire-reports\\dummy.xml
                            echo "</testsuite>" >> target\\surefire-reports\\dummy.xml
                        )
                    '''

                    archiveArtifacts artifacts: 'target/**/*'
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                script {
                    bat '''
                        if exist "target\\allure-results" (
                            echo Generating Allure report...
                            allure generate target\\allure-results -o allure-report-generated
                        ) else (
                            echo No allure results found
                        )
                    '''

                    script {
                        def allureResults = fileExists('target/allure-results')
                        if (allureResults) {
                            allure([
                                includeProperties: false,
                                jdk: '',
                                properties: [],
                                reportBuildPolicy: 'ALWAYS',
                                results: [[path: 'target/allure-results']],
                                report: 'allure-report-jenkins'
                            ])
                        } else {
                            echo 'No Allure results to publish'
                        }
                    }

                    archiveArtifacts artifacts: 'allure-report-generated/**/*'
                }
            }
        }

        stage('Stop Containers') {
            steps {
                script {
                    bat '''
                        echo Stopping Docker containers...
                        set COMPOSE_PROJECT_NAME=autotests-%BUILD_NUMBER%
                        docker-compose -p %COMPOSE_PROJECT_NAME% down -v --remove-orphans

                        rem Очищаем Docker
                        echo Cleaning Docker...
                        docker system prune -f
                        docker volume prune -f
                    '''
                }
            }
        }
    }

    post {
        always {
            junit testResults: 'target/surefire-reports/*.xml', allowEmptyResults: true

            emailext(
                to: 'aleksandr.brynza@simbirsoft.com',
                subject: "${currentBuild.currentResult}: Docker Tests - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                    <h2>${currentBuild.currentResult}: Тесты в Docker контейнерах</h2>
                    <p><b>Проект:</b> ${env.JOB_NAME}</p>
                    <p><b>Сборка:</b> #${env.BUILD_NUMBER}</p>
                    <p><b>Статус:</b> ${currentBuild.currentResult}</p>
                    <p><b>Длительность:</b> ${currentBuild.durationString}</p>

                    <h3>Артефакты:</h3>
                    <ul>
                        <li><a href="${env.BUILD_URL}">Подробности сборки</a></li>
                        <li><a href="${env.BUILD_URL}allure/">Allure отчет</a></li>
                        <li><a href="${env.BUILD_URL}testReport/">JUnit отчет</a></li>
                        <li><a href="${env.BUILD_URL}artifact/">Все файлы</a></li>
                    </ul>

                    <p><small>Запуск в Docker контейнерах с Selenoid</small></p>
                """,
                mimeType: 'text/html',
                attachmentsPattern: 'allure-report-generated/**/*.zip, test-runner.log, selenoid.log'
            )

            cleanWs()
        }
    }
}