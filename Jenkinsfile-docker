pipeline {
    agent any

    environment {
        DOCKER_HOST = "unix:///var/run/docker.sock"
        COMPOSE_PROJECT_NAME = "autotests-${env.BUILD_NUMBER}"
    }

    options {
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    stages {
        stage('Prepare Environment') {
            steps {
                script {
                    sh 'docker --version'
                    sh 'docker-compose --version'

                    sh '''
                        mkdir -p allure-results
                        mkdir -p allure-report
                        mkdir -p test-results
                        mkdir -p selenoid/video
                        mkdir -p selenoid/logs
                    '''
                }
            }
        }

        stage('Build Docker Images') {
            steps {
                script {
                    sh 'docker build -t autotests-runner:latest .'

                    sh 'docker build -t selenoid-custom:latest ./selenoid'
                }
            }
        }

        stage('Start Containers') {
            steps {
                script {
                    sh '''
                        docker-compose up -d selenoid selenoid-ui
                        sleep 10  # Ждем запуска Selenoid

                        # Проверяем что Selenoid запустился
                        curl -f http://localhost:4444/status || exit 1
                    '''
                }
            }
        }

        stage('Run Tests in Docker') {
            steps {
                script {
                    sh '''
                        docker-compose run --rm tests
                    '''
                }
            }

            post {
                always {
                    script {
                        sh '''
                            docker-compose logs tests > test-runner.log
                            docker-compose logs selenoid > selenoid.log
                        '''

                        archiveArtifacts artifacts: 'test-runner.log, selenoid.log'
                    }
                }
            }
        }

        stage('Collect Results') {
            steps {
                script {
                    sh '''
                        # Копируем результаты тестов
                        if [ -d "test-results" ]; then
                            cp -r test-results/* target/ 2>/dev/null || true
                        fi

                        # Копируем Allure результаты
                        if [ -d "allure-results" ]; then
                            cp -r allure-results/* target/allure-results/ 2>/dev/null || true
                        fi

                        # Копируем Allure отчет
                        if [ -d "allure-report" ]; then
                            cp -r allure-report/* target/site/allure-maven-plugin/ 2>/dev/null || true
                        fi
                    '''

                    archiveArtifacts artifacts: 'target/**/*'
                    archiveArtifacts artifacts: 'selenoid/video/**/*'
                    archiveArtifacts artifacts: 'selenoid/logs/**/*'
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                script {
                    sh '''
                        if [ -d "target/allure-results" ]; then
                            allure generate target/allure-results -o allure-report-generated
                        fi
                    '''

                    allure([
                        includeProperties: false,
                        jdk: '',
                        properties: [],
                        reportBuildPolicy: 'ALWAYS',
                        results: [[path: 'target/allure-results']],
                        report: 'allure-report-jenkins'
                    ])

                    archiveArtifacts artifacts: 'allure-report-generated/**/*'
                }
            }
        }

        stage('Stop Containers') {
            steps {
                script {
                    sh '''
                        docker-compose down -v --remove-orphans

                        # Очищаем Docker
                        docker system prune -f
                    '''
                }
            }
        }
    }

    post {
        always {
            junit testResults: 'target/surefire-reports/*.xml', allowEmptyResults: true


            emailext(
                to: 'aleksandr.brynza@simbirsoft.com',
                subject: "${currentBuild.currentResult}: Docker Tests - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                    <h2>${currentBuild.currentResult}: Тесты в Docker контейнерах</h2>
                    <p><b>Проект:</b> ${env.JOB_NAME}</p>
                    <p><b>Сборка:</b> #${env.BUILD_NUMBER}</p>
                    <p><b>Статус:</b> ${currentBuild.currentResult}</p>
                    <p><b>Длительность:</b> ${currentBuild.durationString}</p>

                    <h3>Ссылки:</h3>
                    <ul>
                        <li><a href="${env.BUILD_URL}">Подробности сборки</a></li>
                        <li><a href="${env.BUILD_URL}allure/">Allure отчет</a></li>
                        <li><a href="${env.BUILD_URL}artifact/">Артефакты</a></li>
                    </ul>

                    <p><small>Запуск в Docker контейнерах с Selenoid</small></p>
                """,
                mimeType: 'text/html',
                attachmentsPattern: 'allure-report-generated/**/*.zip'
            )

            cleanWs()
        }
    }
}