pipeline {
    agent any

    environment {
        COMPOSE_PROJECT_NAME = "autotests-${env.BUILD_NUMBER}"
    }

    options {
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    stages {
        stage('Prepare Environment') {
            steps {
                script {
                    bat 'docker --version'
                    bat 'docker-compose --version'

                    bat '''
                        mkdir allure-results 2>nul
                        mkdir allure-report 2>nul
                        mkdir test-results 2>nul
                        mkdir selenoid\\video 2>nul
                        mkdir selenoid\\logs 2>nul
                    '''
                }
            }
        }

        stage('Build Docker Images') {
            steps {
                script {
                    bat 'docker build -t autotests-runner:latest .'

                    bat 'docker build -t selenoid-custom:latest ./selenoid'
                }
            }
        }

        stage('Start Containers') {
            steps {
                script {
                    bat '''
                        docker-compose up -d selenoid selenoid-ui
                        timeout /t 10 /nobreak

                        rem Проверяем что Selenoid запустился
                        curl -f http://localhost:4444/status || exit /b 1
                    '''
                }
            }
        }

        stage('Run Tests in Docker') {
            steps {
                script {
                    bat 'docker-compose run --rm tests'
                }
            }

            post {
                always {
                    script {
                        bat '''
                            docker-compose logs tests > test-runner.log
                            docker-compose logs selenoid > selenoid.log
                        '''

                        archiveArtifacts artifacts: 'test-runner.log, selenoid.log'
                    }
                }
            }
        }

        stage('Collect Results') {
            steps {
                script {
                    bat '''
                        rem Копируем результаты тестов
                        if exist "test-results" (
                            xcopy /E /I /Y test-results\\* target\\ 2>nul
                        )

                        rem Копируем Allure результаты
                        if exist "allure-results" (
                            xcopy /E /I /Y allure-results\\* target\\allure-results\\ 2>nul
                        )

                        rem Копируем Allure отчет
                        if exist "allure-report" (
                            xcopy /E /I /Y allure-report\\* target\\site\\allure-maven-plugin\\ 2>nul
                        )
                    '''

                    archiveArtifacts artifacts: 'target/**/*'
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                script {
                    bat '''
                        if exist "target\\allure-results" (
                            allure generate target\\allure-results -o allure-report-generated
                        )
                    '''

                    allure([
                        includeProperties: false,
                        jdk: '',
                        properties: [],
                        reportBuildPolicy: 'ALWAYS',
                        results: [[path: 'target/allure-results']],
                        report: 'allure-report-jenkins'
                    ])

                    archiveArtifacts artifacts: 'allure-report-generated/**/*'
                }
            }
        }

        stage('Stop Containers') {
            steps {
                script {
                    bat '''
                        docker-compose down -v --remove-orphans
                        docker system prune -f
                    '''
                }
            }
        }
    }

    post {
        always {
            junit testResults: 'target/surefire-reports/*.xml', allowEmptyResults: true

            emailext(
                to: 'aleksandr.brynza@simbirsoft.com',
                subject: "${currentBuild.currentResult}: Docker Tests - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                    <h2>${currentBuild.currentResult}: Тесты в Docker контейнерах</h2>
                    <p><b>Проект:</b> ${env.JOB_NAME}</p>
                    <p><b>Сборка:</b> #${env.BUILD_NUMBER}</p>
                    <p><b>Статус:</b> ${currentBuild.currentResult}</p>
                    <p><b>Длительность:</b> ${currentBuild.durationString}</p>

                    <h3>Ссылки:</h3>
                    <ul>
                        <li><a href="${env.BUILD_URL}">Подробности сборки</a></li>
                        <li><a href="${env.BUILD_URL}allure/">Allure отчет</a></li>
                        <li><a href="${env.BUILD_URL}artifact/">Артефакты</a></li>
                    </ul>

                    <p><small>Запуск в Docker контейнерах с Selenoid</small></p>
                """,
                mimeType: 'text/html',
                attachmentsPattern: 'allure-report-generated/**/*.zip'
            )

            cleanWs()
        }
    }
}