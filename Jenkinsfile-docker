pipeline {
    agent any

    environment {
        COMPOSE_PROJECT_NAME = "autotests-${env.BUILD_NUMBER}"
    }

    options {
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
    }

    stages {
        stage('Cleanup Previous Containers') {
            steps {
                script {
                    bat '''
                        echo Cleaning up previous Docker containers...
                        docker-compose down -v --remove-orphans 2>nul || echo No containers to stop
                        docker system prune -f 2>nul
                    '''
                }
            }
        }

        stage('Prepare Environment') {
            steps {
                script {
                    bat '''
                        mkdir test-output 2>nul
                        mkdir allure-results 2>nul
                        mkdir allure-report 2>nul
                        mkdir target 2>nul
                        rmdir /s /q selenoid\\videos 2>nul
                        mkdir selenoid\\videos 2>nul
                        mkdir selenoid\\logs 2>nul
                    '''
                }
            }
        }

        stage('Build Docker Images') {
            steps {
                script {
                    bat '''
                        docker build -t autotests-runner:latest .
                        docker build -t selenoid-custom:latest ./selenoid
                    '''
                }
            }
        }

        stage('Start Selenoid') {
            steps {
                script {
                    bat '''
                        echo Starting Selenoid...

                        rem Запускаем Selenoid напрямую, так как docker-compose не может обработать имя проекта с дефисами
                        docker run -d \
                            --name selenoid-autotests-%BUILD_NUMBER% \
                            -p 4444:4444 \
                            -v /var/run/docker.sock:/var/run/docker.sock \
                            -v "%cd%\\selenoid\\videos:/opt/selenoid/video" \
                            -v "%cd%\\selenoid\\logs:/opt/selenoid/logs" \
                            -v "%cd%\\browsers.json:/etc/selenoid/browsers.json:ro" \
                            aerokube/selenoid:latest-release

                        rem Ждем запуска
                        echo Waiting for Selenoid to start...
                        ping -n 15 127.0.0.1 >nul

                        rem Проверяем статус
                        curl -f http://localhost:4444/status
                        if errorlevel 1 (
                            echo ERROR: Selenoid failed to start
                            exit /b 1
                        ) else (
                            echo SUCCESS: Selenoid is running!
                        )
                    '''
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    bat '''
                        echo Running tests...

                        rem Запускаем контейнер с тестами
                        docker run --rm \
                            --name tests-autotests-%BUILD_NUMBER% \
                            --network host ^
                            -v "%cd%\\test-output:/app/test-output" ^
                            -v "%cd%\\target:/app/target" ^
                            -e SELENOID_HOST=localhost ^
                            -e SELENOID_PORT=4444 ^
                            -e BROWSER=chrome ^
                            -e TEST_OUTPUT_DIR=/app/test-output ^
                            autotests-runner:latest ^
                            sh -c "
                                echo 'Starting tests...' &&
                                mvn clean test -Dselenium.host=localhost -Dselenium.port=4444 -Dbrowser=$${BROWSER} &&
                                echo 'Tests completed, generating report...' &&
                                mvn allure:report -Dallure.results.directory=$${TEST_OUTPUT_DIR}/allure-results &&
                                cp -r target/surefire-reports $${TEST_OUTPUT_DIR}/ 2>/dev/null || true &&
                                echo 'Results copied to output directory'
                            "

                        if errorlevel 1 (
                            echo WARNING: Tests may have failed, but collecting results...
                        )
                    '''
                }
            }

            post {
                always {
                    script {
                        bat '''
                            rem Сохраняем логи
                            docker logs tests-autotests-%BUILD_NUMBER% > test-runner.log 2>&1
                            docker logs selenoid-autotests-%BUILD_NUMBER% > selenoid.log 2>&1

                            rem Копируем результаты
                            if exist "test-output" (
                                echo Copying test results...
                                xcopy /E /I /Y test-output\\* target\\ 2>nul
                            )

                            rem Создаем структуру каталогов если нет результатов
                            mkdir target\\surefire-reports 2>nul
                            mkdir target\\allure-results 2>nul
                        '''

                        archiveArtifacts artifacts: 'test-runner.log, selenoid.log'
                        archiveArtifacts artifacts: 'target/**/*'
                    }
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                script {
                    bat '''
                        rem Генерируем Allure отчет если есть результаты
                        if exist "target\\allure-results" (
                            echo Generating Allure report...
                            if exist "allure.bat" (
                                allure generate target\\allure-results -o allure-report-generated
                            ) else (
                                echo Allure not found, using Jenkins plugin
                            )
                        ) else (
                            echo No Allure results found
                        )
                    '''

                    script {
                        if (fileExists('target/allure-results')) {
                            allure([
                                results: [[path: 'target/allure-results']],
                                report: 'allure-report'
                            ])
                        }
                    }

                    archiveArtifacts artifacts: 'allure-report-generated/**/*'
                }
            }
        }

        stage('Stop Containers') {
            steps {
                script {
                    bat '''
                        echo Stopping Docker containers...
                        docker stop tests-autotests-%BUILD_NUMBER% 2>nul
                        docker stop selenoid-autotests-%BUILD_NUMBER% 2>nul
                        docker rm selenoid-autotests-%BUILD_NUMBER% 2>nul
                        docker-compose down -v --remove-orphans 2>nul
                    '''
                }
            }
        }
    }

    post {
        always {
            junit testResults: 'target/surefire-reports/*.xml', allowEmptyResults: true

            emailext(
                to: 'aleksandr.brynza@simbirsoft.com',
                subject: "${currentBuild.currentResult}: Docker Tests - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                    <h2>${currentBuild.currentResult}: Тесты в Docker контейнерах</h2>
                    <p><b>Проект:</b> ${env.JOB_NAME}</p>
                    <p><b>Сборка:</b> #${env.BUILD_NUMBER}</p>
                    <p><b>Статус:</b> ${currentBuild.currentResult}</p>
                    <p><b>Длительность:</b> ${currentBuild.durationString}</p>

                    <h3>Артефакты:</h3>
                    <ul>
                        <li><a href="${env.BUILD_URL}">Подробности сборки</a></li>
                        <li><a href="${env.BUILD_URL}allure/">Allure отчет</a></li>
                        <li><a href="${env.BUILD_URL}testReport/">JUnit отчет</a></li>
                        <li><a href="${env.BUILD_URL}artifact/">Все файлы</a></li>
                    </ul>

                    <h3>Логи:</h3>
                    <ul>
                        <li><a href="${env.BUILD_URL}artifact/test-runner.log">Лог тестов</a></li>
                        <li><a href="${env.BUILD_URL}artifact/selenoid.log">Лог Selenoid</a></li>
                    </ul>

                    <p><small>Запуск в Docker контейнерах с Selenoid</small></p>
                """,
                mimeType: 'text/html',
                attachmentsPattern: 'test-runner.log, selenoid.log'
            )

            cleanWs()
        }
    }
}