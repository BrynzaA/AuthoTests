pipeline {
    agent any

    options {
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
    }

    stages {
        stage('Cleanup Previous Containers') {
            steps {
                script {
                    bat '''
                        echo Cleaning up previous Docker containers...
                        docker-compose down -v --remove-orphans 2>nul || echo No containers to stop
                        docker system prune -f 2>nul
                    '''
                }
            }
        }

        stage('Prepare Environment') {
            steps {
                script {
                    bat '''
                        mkdir test-output 2>nul
                        mkdir target 2>nul
                        rmdir /s /q selenoid\\videos 2>nul
                        mkdir selenoid\\videos 2>nul
                        mkdir selenoid\\logs 2>nul

                        rem Очищаем target директорию
                        rmdir /s /q target 2>nul
                        mkdir target 2>nul
                    '''
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    bat 'docker build -t autotests-runner:latest .'
                }
            }
        }

        stage('Start Selenoid') {
            steps {
                script {
                    bat '''
                        echo Starting Selenoid...

                        docker run -d --name selenoid -p 4444:4444 -v /var/run/docker.sock:/var/run/docker.sock -v "%cd%\\selenoid\\videos:/opt/selenoid/video" -v "%cd%\\selenoid\\logs:/opt/selenoid/logs" -v "%cd%\\browsers.json:/etc/selenoid/browsers.json:ro" aerokube/selenoid:latest-release

                        echo Waiting for Selenoid to start...
                        ping -n 10 127.0.0.1 >nul

                        curl -f http://localhost:4444/status
                        if errorlevel 1 (
                            echo ERROR: Selenoid failed to start
                            exit /b 1
                        ) else (
                            echo SUCCESS: Selenoid is running!
                        )
                    '''
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    bat '''
                        echo Running tests...

                        rem Запускаем тесты без монтирования target директории
                        docker run --rm --name tests --network host -v "%cd%\\test-output:/app/test-output" -e SELENOID_HOST=localhost -e SELENOID_PORT=4444 -e BROWSER=chrome -e TEST_OUTPUT_DIR=/app/test-output autotests-runner:latest sh -c "echo 'Starting tests...' && mvn clean test -Dselenium.host=localhost -Dselenium.port=4444 -Dbrowser=\\$${BROWSER} -DskipTests=false && echo 'Tests completed, generating report...' && mvn allure:report -Dallure.results.directory=\\$${TEST_OUTPUT_DIR}/allure-results && cp -r target/surefire-reports \\$${TEST_OUTPUT_DIR}/ 2>/dev/null || true && echo 'Results copied to output directory'"

                        if errorlevel 1 (
                            echo WARNING: Tests may have failed, but collecting results...
                        )
                    '''
                }
            }
        }

        stage('Collect Results') {
            steps {
                script {
                    bat '''
                        echo Collecting test results...

                        docker logs tests > test-runner.log 2>&1
                        docker logs selenoid > selenoid.log 2>&1

                        rem Копируем результаты из контейнера
                        echo Copying results from container...
                        docker cp tests:/app/target/surefire-reports target/ 2>nul || echo No surefire reports
                        docker cp tests:/app/target/allure-results target/ 2>nul || echo No allure results
                        docker cp tests:/app/target/allure-report target/ 2>nul || echo No allure report

                        rem Также проверяем test-output
                        if exist "test-output" (
                            echo Copying from test-output...
                            xcopy /E /I /Y test-output\\* target\\ 2>nul
                        )

                        rem Создаем структуру если пусто
                        mkdir target\\surefire-reports 2>nul
                        mkdir target\\allure-results 2>nul
                        mkdir target\\allure-report 2>nul
                    '''

                    archiveArtifacts artifacts: 'test-runner.log, selenoid.log'
                    script {
                        if (fileExists('target')) {
                            archiveArtifacts artifacts: 'target/**/*'
                        }
                    }
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                script {
                    bat '''
                        if exist "target\\allure-results" (
                            echo Generating Allure report...
                            dir target\\allure-results
                        ) else (
                            echo No Allure results found
                        )
                    '''

                    script {
                        if (fileExists('target/allure-results')) {
                            allure([
                                results: [[path: 'target/allure-results']],
                                report: 'target/allure-report'
                            ])

                            archiveArtifacts artifacts: 'target/allure-report/**/*'
                        }
                    }
                }
            }
        }

        stage('Stop Containers') {
            steps {
                script {
                    bat '''
                        echo Stopping Docker containers...
                        docker stop tests 2>nul
                        docker stop selenoid 2>nul
                        docker rm selenoid 2>nul
                    '''
                }
            }
        }
    }

    post {
        always {
            script {
                if (fileExists('target/surefire-reports')) {
                    junit testResults: 'target/surefire-reports/*.xml', allowEmptyResults: true
                } else {
                    echo 'No test results found for JUnit report'
                }
            }

            emailext(
                to: 'aleksandr.brynza@simbirsoft.com',
                subject: "${currentBuild.currentResult}: Docker Tests - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                    <h2>${currentBuild.currentResult}: Тесты в Docker контейнерах</h2>
                    <p><b>Проект:</b> ${env.JOB_NAME}</p>
                    <p><b>Сборка:</b> #${env.BUILD_NUMBER}</p>
                    <p><b>Статус:</b> ${currentBuild.currentResult}</p>
                    <p><b>Длительность:</b> ${currentBuild.durationString}</p>

                    <h3>Артефакты:</h3>
                    <ul>
                        <li><a href="${env.BUILD_URL}">Подробности сборки</a></li>
                        <li><a href="${env.BUILD_URL}allure/">Allure отчет</a></li>
                        <li><a href="${env.BUILD_URL}testReport/">JUnit отчет</a></li>
                        <li><a href="${env.BUILD_URL}artifact/">Все файлы</a></li>
                    </ul>

                    <h3>Логи:</h3>
                    <ul>
                        <li><a href="${env.BUILD_URL}artifact/test-runner.log">Лог тестов</a></li>
                        <li><a href="${env.BUILD_URL}artifact/selenoid.log">Лог Selenoid</a></li>
                    </ul>

                    <p><small>Запуск в Docker контейнерах с Selenoid</small></p>
                """,
                mimeType: 'text/html',
                attachmentsPattern: 'test-runner.log, selenoid.log'
            )

            cleanWs()
        }
    }
}