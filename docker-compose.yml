version: '3.8'

networks:
  test-network:
    driver: bridge

services:
  selenoid:
    build: ./selenoid
    container_name: selenoid-${COMPOSE_PROJECT_NAME}
    ports:
      - "4444:4444"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./selenoid/videos:/opt/selenoid/video"
      - "./selenoid/logs:/opt/selenoid/logs"
    networks:
      - test-network
    restart: unless-stopped

  tests:
    build: .
    container_name: tests-${COMPOSE_PROJECT_NAME}
    depends_on:
      - selenoid
    volumes:
      - maven-repo:/root/.m2
      - ./test-output:/app/test-output
    environment:
      - SELENOID_HOST=selenoid-${COMPOSE_PROJECT_NAME}
      - SELENOID_PORT=4444
      - BROWSER=chrome
      - MAVEN_OPTS=-Dmaven.repo.local=/root/.m2/repository
      - TEST_OUTPUT_DIR=/app/test-output
    networks:
      - test-network
    command: >
      sh -c "
        echo 'Starting tests...' &&
        mvn clean test -Dselenium.host=selenoid-${COMPOSE_PROJECT_NAME} -Dselenium.port=4444 -Dbrowser=$${BROWSER} &&
        echo 'Tests completed, generating report...' &&
        mvn allure:report -Dallure.results.directory=$${TEST_OUTPUT_DIR}/allure-results &&
        cp -r target/surefire-reports $${TEST_OUTPUT_DIR}/ 2>/dev/null || true &&
        echo 'Results copied to output directory'
      "
    restart: "no"

volumes:
  maven-repo:
    driver: local