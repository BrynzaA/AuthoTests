version: '3.8'

networks:
  test-network:
    driver: bridge

services:
  selenoid:
    build: ./selenoid
    container_name: selenoid
    ports:
      - "4444:4444"
      - "8080:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./selenoid/video:/opt/selenoid/video"
      - "./selenoid/logs:/opt/selenoid/logs"
    environment:
      - OVERRIDE_VIDEO_OUTPUT_DIR=./selenoid/video
    networks:
      - test-network
    restart: unless-stopped

  selenoid-ui:
    image: "aerokube/selenoid-ui:latest"
    container_name: selenoid-ui
    links:
      - selenoid
    ports:
      - "8090:8090"
    command: ["--selenoid-uri", "http://selenoid:4444"]
    networks:
      - test-network
    restart: unless-stopped

  tests:
    build: .
    container_name: autotests-runner
    depends_on:
      - selenoid
    volumes:
      - maven-repo:/root/.m2
      - ./test-results:/app/target
      - ./allure-results:/app/target/allure-results
      - ./allure-report:/app/target/site/allure-maven-plugin
    environment:
      - SELENOID_HOST=selenoid
      - SELENOID_PORT=4444
      - BROWSER=chrome
      - MAVEN_OPTS=-Dmaven.repo.local=/root/.m2/repository
      - JAVA_OPTS=-Xmx1024m -XX:MaxPermSize=256m
    networks:
      - test-network
    command: >
      sh -c "mvn clean test allure:report -Dselenium.host=selenoid -Dselenium.port=4444 -Dbrowser=${BROWSER:-chrome}"
    restart: "no"

volumes:
  maven-repo:
    driver: local