# docker-compose.yml
services:
  selenoid:
    image: aerokube/selenoid:latest-release
    container_name: selenoid
    ports:
      - "4444:4444"
    volumes:
      - "./selenoid/config:/etc/selenoid:ro"
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./selenoid/video:/opt/selenoid/video"
      - "./selenoid/logs:/opt/selenoid/logs"
    environment:
      - OVERRIDE_VIDEO_OUTPUT_DIR=/opt/selenoid/video
    command: >
      -conf /etc/selenoid/browsers.json
      -limit 5
      -log-output-dir /opt/selenoid/logs
      -video-output-dir /opt/selenoid/video
      -timeout 2m
    restart: unless-stopped
    networks:
      - test-network

  selenoid-ui:
    image: aerokube/selenoid-ui:latest-release
    container_name: selenoid-ui
    ports:
      - "8080:8080"
    environment:
      - SELENOID_URL=http://selenoid:4444
    depends_on:
      - selenoid
    networks:
      - test-network

  tests:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: autotests
    depends_on:
      selenoid:
        condition: service_started
    volumes:
      - "./target:/app/target"
      - "./allure-report:/app/allure-report"
      - "maven-repo:/app/.m2/repository"
    environment:
      - USE_GRID=true
      - REMOTE_URL=http://selenoid:4444/wd/hub
      - BROWSER=chrome
      - ALLURE_RESULTS_DIR=/app/target/allure-results
    networks:
      - test-network
    working_dir: /app
    command: >
      bash -c "
        echo 'Waiting for Selenoid...' &&
        sleep 30 &&
        echo 'Starting tests...' &&
        mvn clean test -Dtestng.xml=src/test/resources/testng.xml &&
        echo 'Generating Allure report...' &&
        mvn allure:report &&
        cp -r /app/target/site/allure-maven-plugin/* /app/allure-report/ 2>/dev/null || true &&
        echo 'Tests completed!'
      "

volumes:
  maven-repo:

networks:
  test-network:
    driver: bridge